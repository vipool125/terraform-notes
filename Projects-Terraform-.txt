Terraform+aws provideers connect  through aws-cli 

A.AWS-cli Install
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64-2.0.30.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install


Aws --version

B.How to connect local to aws cli
Aws configure
Terraform.tf>>>providers


terraform {
  required_providers {
    aws = {
      source = "hashicorp/aws"
      version = "6.15.0"
    }
  }
}

Main.tf >>>
Sample s3 bucket from anywhere
terraform init
terraform validate
terraform plan 
Terraform apply
Aws console s3 check service


Create user IAM
Access and secreeat key 
Aws s3 ls



Create a ec2 instance from the local 
Need to configure from the local


Aws confugure
Copy and paster access and secreat key from the IAM  to here



While crreate a ec2 instance ..need a public. And private key 
Enter file in which to save the key (/Users/vipuldeshmukh/.ssh/id_ed25519): terra-key-ec2

Ssh-keygen
Public and private key
terra-key-ec2 create the time ssh-kegen


#key-pair
resource "aws_security_group" "mysecurity" {
  name        = "allow_tls"
  description = "Allow TLS inbound traffic and all outbound traffic"
  vpc_id      = aws_default_vpc.default.id #interpolation

  #inbound rule
  ingress  {
    from_port=22
    to_port=22
    protocol="tcp"
   # cidr_block=["0.0.0.0/0"]
    cidr_blocks = ["0.0.0.0/0"]
  }

  ingress  {
    from_port=22
    to_port=22
    protocol="tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  #outboud rule
  egress  {
    from_port=0
    to_port=0
    protocol=-1  #all port covered
    # cidr_block=["0.0.0.0/0"]
    cidr_blocks = ["0.0.0.0/0"]
  }
  tags = {
    Name = "allow_tls"
  }
}

#ec2 instance
resource "aws_instance" "my_instance" {
  key_name = aws_key_pair.deployer.key_name  #come here >terra-key-ec2"
  security_groups = [aws_security_group.mysecurity.name] #interpolation
  ami           = "ami-0360c520857e3138f"  #ubuntu>>take from ec2 instance where youhave a make
  instance_type = "t2.micro"
  root_block_device {
    volume_size = 15
    volume_type = "gp3"
  }
  tags = {
    Name = "vipul-first-time" #instance-name
  }
}

terraform plan
terraform apply


After the apply
Vs code consolde
>>chmod 400 terra-key-ec2
>>ssh -i "terra-key-ec2." ubuntu@ec2-100-24-8-142.compute-1.amazonaws.com >>**not .pem here


>>from above step you have directly connect to the local to ec2 instance>>launch a website






Variable.tf
#key-pair
resource "aws_key_pair" "deployer" {
  key_name   ="terra-key-ec2"
  public_key = file("terra-key-ec2.pub")
}

resource "aws_default_vpc" "default" {
  
}

resource "aws_security_group" "mysecurity" {
  name        = "allow_tls"
  description = "Allow TLS inbound traffic and all outbound traffic"
  vpc_id      = aws_default_vpc.default.id
  #inbound rule
  ingress  {
    from_port=22
    to_port=22
    protocol="tcp"
   # cidr_block=["0.0.0.0/0"]
    cidr_blocks = ["0.0.0.0/0"]
  }

  ingress  {
    from_port=22
    to_port=22
    protocol="tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  #outboud rule
  egress  {
    from_port=0
    to_port=0
    protocol="-1"  #all port covered
    # cidr_block=["0.0.0.0/0"]
    cidr_blocks = ["0.0.0.0/0"]
  }
  tags = {
    Name = "allow_tls"
  }
}

#ec2 instance
resource "aws_instance" "my_instance" {
  key_name = aws_key_pair.deployer.key_name  #come here >terra-key-ec2"
  security_groups = [aws_security_group.mysecurity.name]
  
  ami=var.ec2_ami_id>>>>>>>.  Varibale is used defined file
  instance_type = var.ec2_instance_type. #Varibale is used defined file
  root_block_device {
    volume_size=var.ec2_root_storage_size  #Varibale is used defined file
    volume_type = "gp3"
  }
  tags = {
    Name = "vipul-first-time"
  }
}



Variable.tf  >>>>use dyanamically that time use
#"ec2_instance_type" >>you can write anythein =g here insted
variable "ec2_instance_type" {
  default = "t2.micro"
  type = string
  
}
variable "ec2_root_storage_size" {
  default = "10"
  type = number
  
}
variable "ec2_ami_id" {
  default = "ami-0360c520857e3138f"
  type = string
  
}



Output block

If you want to show all ypur output at the vs code terminal>>without go to the aws console ,,then write a output block




output "ec2_public_ip" {
  value = aws_instance.my_instance.public_ip
  
  
}
output "ec2_public_dns" {
  value = aws_instance.my_instance.public_dns
}
output "ec2_private_ip" {
  value = aws_instance.my_instance.private_ip
}


Terraform plan

ec2_private_ip = "172.31.23.136"
ec2_public_dns = "ec2-54-160-141-99.compute-1.amazonaws.com"
ec2_public_ip = "54.160.141.99"


Show this one >>then
Do it 
ssh -i terra-key-ec2 ubuntu@ec2-54-160-141-99.compute-1.amazonaws.com


Simultaneously ec2 and nginx installed ,how to do it

If you want install anything at the time of creating instanve you have use >>user_data



#key-pair
resource "aws_key_pair" "deployer" {
  key_name   ="terra-key-ec2"
  public_key = file("terra-key-ec2.pub")
}

resource "aws_default_vpc" "default" {
  
}

resource "aws_security_group" "mysecurity" {
  name        = "allow_tls"
  description = "Allow TLS inbound traffic and all outbound traffic"
  vpc_id      = aws_default_vpc.default.id
  #inbound rule
  ingress  {
    from_port=22
    to_port=22
    protocol="tcp"
   # cidr_block=["0.0.0.0/0"]
    cidr_blocks = ["0.0.0.0/0"]
  }

  ingress  {
    from_port=22
    to_port=22
    protocol="tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  #outboud rule
  egress  {
    from_port=0
    to_port=0
    protocol="-1"  #all port covered
    # cidr_block=["0.0.0.0/0"]
    cidr_blocks = ["0.0.0.0/0"]
  }
  tags = {
    Name = "allow_tls"
  }
}

#ec2 instance
resource "aws_instance" "my_instance" {
  key_name = aws_key_pair.deployer.key_name  #come here >terra-key-ec2"
  security_groups = [aws_security_group.mysecurity.name]
  
  ami=var.ec2_ami_id
  user_data = file("install_nginx.sh")>>>>>>>>>>>>>>>.  User_data
  instance_type = var.ec2_instance_type
  root_block_device {
    volume_size=var.ec2_root_storage_size
    volume_type = "gp3"
  }
  tags = {
    Name = "vipul-first-time"
  }
}



terraform apply -auto-approve

ec2_private_ip = "172.31.27.239"
ec2_public_dns = "ec2-54-83-119-246.compute-1.amazonaws.com"
ec2_public_ip = "54.83.119.246"

ssh -i terra-key-ec2 ubuntu@IP address from the above>> ssh -i terra-key-ec2 ubuntu@54.83.119.246

>>54.83.119.246>>>>chrome




Dyanamic Block or meta arguments

For each
count


resource "aws_instance" "my_instance" {
  key_name = aws_key_pair.deployer.key_name  #come here >terra-key-ec2"
  security_groups = [aws_security_group.mysecurity.name]
  count=2>>>multiple instance launcheed
  
  ami=var.ec2_ami_id
  user_data = file("install_nginx.sh")>>>>>>>>>>>>>>>.  User_data
  instance_type = var.ec2_instance_type
  root_block_device {
    volume_size=var.ec2_root_storage_size
    volume_type = "gp3"
  }
  tags = {
    Name = "vipul-first-time"
  }
}


Output.tf



# for the single instance
# output "ec2_public_ip" {
#   value = aws_instance.my_instance.public_ip  #singele instance o/p


# }
# output "ec2_public_dns" {
#   value = aws_instance.my_instance.public_dns
# }
# output "ec2_private_ip" {
#   value = aws_instance.my_instance.private_ip
# }

#for multiple instances c==3>>need a abstrict  *

output "ec2_public_ip" {
  value = aws_instance.my_instance[*].public_ip  #multiple o/p


}
output "ec2_public_dns" {
  value = aws_instance.my_instance[*].public_dns
}
output "ec2_private_ip" {
  value = aws_instance.my_instance[*].private_ip
}

At a time only one is used either foreach or count



Depends_on
In Terraform, depends_on is a meta-argument that explicitly declares dependencies between resources, modules, or data sources. This ensures Terraform creates or updates resources in the correct order,


resource "aws_instance" "example" {
  ami           = var.ec2_ami_id
  instance_type = "t2.micro"

  depends_on = [
    aws_security_group.mysecurity
  ]
}

Terraform will  aws_security_group.mysecurity to be created before creating the instance.

aws_key_pair.deployer: Refreshing state... [id=terra-key-ec2]
aws_default_vpc.default: Refreshing state... [id=vpc-041838d3e953cf19c]
aws_security_group.mysecurity: Refreshing state... [id=sg-09d84b8edf268b93f]
aws_instance.my_instance["sakshi"]: Refreshing state... [id=i-0f08d5ab8070cdb9b]<<<<<<<<instance is create after a security group
aws_instance.my_instance["vipul"]: Refreshing state... [id=i-0858ece8b5cb58a33]<<<<<<<





Conditional expressions

condition ? true_value : false_value

â€¢ If condition is true, Terraform uses true_value.
â€¢ If condition is false, Terraform uses false_value.





Terraform state management
Dp Terraform apply  before do any thing

Terraform state file

Aws_key_pair
terraform state list  
Terraform rm state 
Terraform import  >> if something happen or exist at tf ,but not in  aws >>4:05:min train with shubham
Import anything >>ec3,s3

Terraform refresh


If any resource or instance is deleted at the side of terraform ,how to know to aws and vice versa


From terraform throgh aws state mngt happen or aws thorugh tf>>must be terraform





Terraform secure state management >>important


Terraform state file can I commit to github or can I delete it
Tf state cant be commit to github



If aws have 3 count(instance) and terraform statefile have 2>>conflict (multiple stat file conflict)


Remote backend 3
Statefile locking using dyanomodb


Remote infra
Dyanomodb
S3
Providers
Terraform.tf

Terraform plan
Dyanmodb >>>make it at aws console


Restoring from a Local terraform.tfstate.backup file:
â€¢ Locate the backup file: 
Terraform automatically creates a terraform.tfstate.backup file in the same directory as your terraform.tfstate file whenever a change is applied




Rename the backup file: 
If your terraform.tfstate file is corrupted or missing, rename terraform.tfstate.backup to terraform.tfstate.

    mv terraform.tfstate.backup terraform.tfstate

â€¢ Initialize Terraform: 
Run terraform init to ensure Terraform is correctly configured with the restored state.
â€¢ Verify with terraform plan: 
Run terraform plan to compare the restored state with your current configuration and identify any discrepancies before applying changes.


terraform state list
Init
apply

terraform import aws_key_pair.deployer terra-key-ec2 >>>>import the existing key-pair
Same for the vpac
Find its ID from the AWS console or CLI:
 aws ec2 describe-security-groups --region us-east-1

o/p
{
    "SecurityGroups": [
        {
            "GroupId": "sg-0f1cced7d31ae623c",
            "IpPermissionsEgress": [
                {


Commands
terraform import aws_key_pair.deployer terra-key-ec2
>>terraform import aws_security_group.mysecurity <GroupId-value>

For the purpose of the configure the terraform backend ,need to change or config terraform backend block


  backend "s3" {
    bucket = "vipul-terraform-state-662012768016"
    key = "terraform.tfstate"
    region = "us-east-1"
    dynamodb_table = "my_vipul_dynamodb-table-1"
  }
}



>>whenever you change the terraforf.tf >>must be perfrom terraform init


terraform init




If the we doing the state lock release,the key present insidwe dyanomodb is it delete or not>>>delete


Jab tk koi Id present hai inside a dynonmodb ,no one is access using another key






I have worked on terraform state management, workspaces

Terraform workspaces

A workspace in Terraform is an isolated environment that allows you to use the same Terraform configuration for multiple environments â€” like dev, staging, prod, etc. â€” each with its own state file.
environment-specific state files 


default   â†’ local testing
dev       â†’ developer environment
staging   â†’ staging setup
prod      â†’ production infrastructure


Without Workspaces	 With Workspaces
You must duplicate .tf files for each environment	 One .tf codebase, multiple environments
Harder to maintain consistency	 Easier to manage and promote changes
Single state file shared for all	Each workspace has its own state


Command	Description
terraform workspace list	Lists all workspaces
terraform workspace show	Shows the current active workspace
terraform workspace new <name>	Creates a new workspace
terraform workspace select <name>	Switches to an existing workspace
terraform workspace delete <name>	Deletes a workspace (must not be active)


terraform workspace new dev
terraform workspace select dev
terraform workspace list


Use Case	Recommended?
Small projects with same infra per env	âœ… Yes
Large infra with major differences per env	âŒ Better use separate folders or repos
Terraform Cloud (multiple teams/environments)	âœ… Common




Terraform Modules

A module in Terraform is simply a collection of .tf files that work together as a reusable unit of infrastructure.

ğŸ§© A â€œfunctionâ€ or â€œpackageâ€ in Terraform â€” instead of writing all resources every time, you group them and reuse them anywhere.



wo Types of Modules
	1. Root Module
		â—‹ The code in your main working directory (where you run terraform apply).
		â—‹ Example: main.tf, variables.tf, etc.
	2. Child Module
		â—‹ A reusable module, either:
			Â§ Local (from your file system)
			Â§ Remote (from Terraform Registry or GitHub)

ğŸ“¦ Example
ğŸ§± Without a Module

resource "aws_vpc" "my_vpc" {
  cidr_block = "10.0.0.0/16"
}
resource "aws_subnet" "my_subnet" {
  vpc_id     = aws_vpc.my_vpc.id
  cidr_block = "10.0.1.0/24"
}
You repeat this every time you need a new VPC.

ğŸ§© With a Module
Instead, use the official AWS VPC module:

module "vpc" {
  source = "terraform-aws-modules/vpc/aws"
  
  name = "my-vpc"
  cidr = "10.0.0.0/16"
azs             = ["us-east-1a", "us-east-1b"]
  public_subnets  = ["10.0.1.0/24", "10.0.2.0/24"]
  private_subnets = ["10.0.101.0/24", "10.0.102.0/24"]
enable_nat_gateway = true
}
This single module block automatically creates:
	â€¢ VPC
	â€¢ Subnets
	â€¢ Internet gateway
	â€¢ NAT gateway
	â€¢ Route tables
	â€¢ Everything configured correctly ğŸ¯

ğŸ”— How It Works

module "name" {
  source = "where-to-get-it"
  # input variables
}
	â€¢ source â†’ tells Terraform where the module code is (registry, git, or local folder).
	â€¢ Inputs (like name, cidr, etc.) are variables defined inside that module.
	â€¢ Terraform downloads the module, plugs in your inputs, and runs it as part of your plan.

ğŸ“š Common Sources
Source Type	Example
Terraform Registry	source = "terraform-aws-modules/vpc/aws"
GitHub	source = "github.com/user/repo//path/to/module"
Local Path	



I have managed multienvironmemt struructure using terraform module ans workspace


How to create multi-env vpcs using modules and workspaces
Ec2 module using module
S3 and so on

Locals

See project on the notebook for the next
https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest





